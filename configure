#!/usr/bin/env bash

set -e

function err() {
    echo
    echo "$@" 1>&2
    exit 1
}

printf "Looking for c++ compiler... "
for x in clang++ g++; do
    if which $x &>/dev/null; then
        cxx=$x
        break
    fi
done
if [ -z "$cxx" ]; then
    err "Cannot locate c++ compiler."
fi
printf "OK: ${cxx}\n"

case $(uname) in
    Darwin)
        cxxflags="-std=c++11 -g -Wall"
        ldflags="-lrt -lpthread"
        ;;        
    *)
        cxxflags="-std=c++11 -g -Wall"
        ldflags="-lrt -lpthread"
        ;;
esac

function find_file() {
    local description="$1"
    local sane_location="$2"
    local find_root="$3"
    local find_path="$4"
    local result=""

    printf "Searching for ${description}... " > /dev/tty
    if [ -f "${sane_location}" ]; then
        result="${sane_location}"
    else
        result=$(find "${find_root}" -path "${find_path}" | tail -1)
    fi

    if [ -z "${result}" ]; then
        err "Cannot locate ${find_path}"
    fi
    printf "OK: ${result}\n" > /dev/tty
    
    echo "${result}"
}

clang_index_h=$(find_file "libclang headers" "/usr/include/clang-c/Index.h" "/usr" "*/clang-c/Index.h")
clang_include=$(dirname $(dirname ${clang_index_h}))

libclang_so=$(find_file "libclang library" "/usr/lib/libclang.so" "/usr" "*/libclang.so")
clang_lib=$(dirname ${libclang_so})

printf "generating Makefile.conf..."
sed -e "s|__configure_cxx__|$cxx|" \
    -e "s|__configure_cxxflags__|$cxxflags|" \
    -e "s|__configure_ldflags__|$ldflags|" \
    -e "s|__configure_clang_include__|$clang_include|" \
    -e "s|__configure_clang_lib__|$clang_lib|" \
    Makefile.conf.in > Makefile.conf
printf "OK\n"