#!/usr/bin/env bash

set -e

# Contains find_program() and find_file()
source dev/etc/configure-util.sh

cxx=$(find_program "c++ compiler" "clang++ g++")

case $(uname) in
    Darwin)
        cxxflags="-std=c++11 -g -Wall"
        ldflags="-lpthread"
        if ! [ -e dev/ext/include/clang-c ]; then
            (
                echo "Downloading clang headers..."
                set -e
                mkdir -p dev/ext/include
                cd dev/ext/include
                svn export http://llvm.org/svn/llvm-project/cfe/trunk/include/clang-c/
                echo "Downloading clang headers...OK"
            )
        else
            echo "Found clang headers."
        fi
        clang_include="-I$PWD/dev/ext/include"
        clang_lib_dir="`xcode-select --print-path`/Toolchains/XcodeDefault.xctoolchain/usr/lib"
        clang_lib="-rpath ${clang_lib_dir} -L${clang_lib_dir} -lclang"
        ;;        
    *)
        cxxflags="-std=c++11 -g -Wall"
        ldflags="-lrt -lpthread"
        clang_index_h=$(find_file "libclang headers" "clang-c/Index.h" "/usr/include" "/usr")
        clang_include="-I$(dirname $(dirname ${clang_index_h}))"
        clang_lib=$(find_file "libclang library" "libclang.so" "/usr/lib" "/usr")
        ;;
esac


printf "generating Makefile.conf..."
sed -e "s|__configure_cxx__|$cxx|" \
    -e "s|__configure_cxxflags__|$cxxflags|" \
    -e "s|__configure_ldflags__|$ldflags|" \
    -e "s|__configure_clang_include__|$clang_include|" \
    -e "s|__configure_clang_lib__|$clang_lib|" \
    dev/etc/Makefile.conf.in > Makefile.conf
printf "OK\n"

echo "==="
echo "=== Configure completed successfully"
echo "==="